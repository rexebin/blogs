# 概述

Angular的依赖注入系统是它最重要的特征之一。该依赖注入系统是一种利用注入器即时创建和提供服务的机制。它是由一个多级注入器树所组成，它的顶部为应用级别根注入器，下面有所有懒惰加载模块根注入器和组件注入器树组成。Angular为每个模块、组件、指令、服务和管道等都准备了一份注入器，这些注入器上下关联，形成一个注入器树形结构。

要真正掌握如何使用Angular编写应用程序，深刻理解它的依赖注入系统的潜规则和服务的作用范围是至关重要的。

本文针对的是对Angular的多级依赖注入系统、模块和路由有一定了解的读者群体。**本文的重点在于讲述依赖注入的服务的作用范围**。推荐阅读官方的下列文档：

1. [依赖注入](https://angular.cn/docs/ts/latest/guide/dependency-injection.html)
1. [多级依赖注入](https://angular.cn/docs/ts/latest/guide/hierarchical-dependency-injection.html)
1. [Angular模块（NgModule）](https://angular.cn/docs/ts/latest/guide/ngmodule.html)
1. [路由与导航](https://angular.cn/docs/ts/latest/guide/router.html)

简而言之，依赖注入是通过在不同级别上，将服务令牌添加到所在元数据的服务提供商(providers)数组中来配置并实现的。

Angular的服务有下面几个特征：

1. **单例性**：

    所谓单例性，针对的是注入器，而非服务的类。它不是说一个服务类只能实例化一次，而是指在任何一级注入器创建的服务的实例是唯一的。唯一的意思是在它作用范围内的任何角落将该服务注入进来所得到的都是同一个实例，同一个对象，拥有同样的属性和值。如果一个组件更改了该服务实例的某属性的值，之后，在其它组件所得到的将是同一个属性已经变化了的实例，这正是为什么我们可以使用服务在组件中共享数据的原因。

    同一个服务类可以在多级注入器被多次创建，从而产生多个实例。每个实例在自己的作用域内都是单例的。

1. **作用域由上至下**：

    在任何一级注入器所创建的服务实例，它的作用范围辐射并局限于自己以及所有子级。注意，该实例的上级或者邻居注入器对其无访问权。

1. **服务查询由下至上**：

    当在一个组件、指令、服务和管道等的类构造函数中请求一个服务时，Angular从当前类所在的注入器开始寻找，如果没有找到合适的服务提供商，那么Angular便向上一级注入器查询，以此类推，直到找到第一个合适的提供商，如果该级注入器还没有所需服务的实例，则创建一个实例并完成注入。如果该级注入器已经存有所需服务的实例，则直接使用现有实例注入。如果一路查询到根注入器都没有找到合适的提供商，那么Angular便会报错。

    **值得注意的是，当Angular由下至上找到第一个合适的服务时，它将立刻停止查找，忽略上面所有注入器，不管它们是否也有符合条件的服务。** 这样确保了每一个依赖请求都有一个可以预见的服务对应。

什么构成上下级的关系呢？有以下几种情况：

1. 根模块注入器是所有懒惰加载模块注入器的上级

1. 模块注入器是模块内其它注入器的上级

1. 组件是自己的视图子级(ViewChildren)和内容子级(ContentChildren)的上级。
    * 视图子级是在自己模板中使用的组件、指令、管道等。
    * 内容子级是自己选择器中间包含的内容，比如
    ```
    <parent-component>
        <content-children></content-children>    
    </parent-component>
    ```

# Angular服务的作用范围

## 根模块、主动加载模块和懒惰加载模块的服务

### 模块

Angular模块是带有@NgModule装饰器函数的类，用来管理整个Angular应用的所有组件、指令、管道和服务。几乎所有Angular自带程序库、外部程序库都是一模块的形式封装的。详情参见[Angular模块（NgModule）](https://angular.cn/docs/ts/latest/guide/ngmodule.html)和[Angular模块常见问题](https://angular.cn/docs/ts/latest/cookbook/ngmodule-faq.html)。

每个Angular应用都有一个根模块，它是用来配置所有应用级别范围服务的最佳地点。最佳实践是为所有应用级别的服务创建一个CoreModule，将CoreModule导入到根模块中，并只在根模块中导入CoreModule。

根模块的注入器为根注入器，所有其它注入器都是它的子级。跟注入器中的服务的作用范围贯穿整个应用。

### 特性模块

特性模块分为两种：主动加载模块和懒惰加载模块。

1. 主动加载模块是在Angular启动时，会被自动加载的模块，一般是Angular应用启动后需要立刻用到的少数模块。

1. 懒惰加载模块在Angular启动时不会被立刻加载，而是在用户通过路由器第一次访问该模块时才加载。除了应用立刻启动后的默认视图和少部分必须的主动加载模块外，所有其它模块都应该设计为懒惰加载模块。 

Angular对它们的提供商的处理方法截然不同。

1. 主动加载模块的服务提供商被Angular升级到根注入器中，作用范围贯穿整个应用。这样设计的主要原因是为了让我们能够通过模块扩展应用。

1. 懒惰加载模块拥有自己独立的注入器，它的服务提供商不会被升级到根注入器，服务的作用贯穿整个模块。原因有两点：
    * Angular的注入器被第一次调用后，将无法在对其进行配置。所以在根注入器被配置并启用以后，它已经被关闭，无妨向其添加服务。所以就算Angular开发小组想要升级懒惰加载的服务，也是无法做到的。
    * 懒惰加载拥有自己的独立注入器，为我们提供了一种将服务作用域控制在模块内的方法。    

提供服务的最佳实践是使用模块来配置服务提供商，除非想要将服务提供商的作用域控制在组件树内。参见[下面](#组件级服务)的解释。

## 组件级服务

如果想要将服务提供商的作用范围控制在组件以及它的子级之内，则在组件内提供服务，将服务提供商添加到组件元数据的providers数组中即可。

1. 每次Angular创建该组件的实例时，都会创建并注入一个新的服务实例。该实例的作用范围覆盖所有自己组件。
1. 如果该组件没有任何子级，它服务则只为自己所用。并且在每次创建该组件时，创建新的服务实例。

## 路由组件和子级路由组件的服务

通过路由访问的组件包括两种：
1. 带有<router-outlet></router-outlet>路由插座的宿主组件
1. 被路由器放置到路由插座中间的子级路由组件

在上面的组件中，服务提供商的作用域是什么呢？首先我们要弄清楚注入器的上下级关系：

1. <router-outlet>本身是一个组件，它是所在宿主组件的子级，是视图子级（ViewChildren）。
1. 被路由器放置到<router-outlet>组件中的组件是<router-outlet>组件的子级，是内容子级（ContentChildren）。

不难看出，服务的作用域为：

1. 宿主组件注入器的服务覆盖所有被注入到器路由插座的所有组件。以此类推。
1. 有路由放置到路由插座的组件所提供的服务作用范围只向下辐射。
1. 被路由器平行放置到路由插座的所有组件之间并无父子关系，所以它们的服务不能被互相访问。 




